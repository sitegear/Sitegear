<?php
/**
 * @var \Sitegear\Core\View\View $view
 * @var \Sitegear\Ext\Module\Customer\Model\TransactionItem $item
 */
$view->getStringsManager()->prepend('title', $view['title'])
?>
<h1><?php echo $view['heading']; ?></h1>
<p>
<?php
$trolleyEmpty = !isset($view['trolley-data']) || empty($view['trolley-data']);
if ($trolleyEmpty) {
	echo $view['text']['no-items'];
} else {
	echo \Sitegear\Util\TokenUtilities::replaceTokens(
		sizeof($view['trolley-data']) === 1 ? $view['text']['items-count'][0] : $view['text']['items-count'][1],
		array(
			'count' => sizeof($view['trolley-data'])
		)
	);
?>
</p>
<table>
	<thead>
	<tr>
		<th><?php echo $view['text']['table-headings']['item']; ?></th>
		<th><?php echo $view['text']['table-headings']['details']; ?></th>
		<th><?php echo $view['text']['table-headings']['price']; ?></th>
		<th><?php echo $view['text']['table-headings']['quantity']; ?></th>
		<th><?php echo $view['text']['table-headings']['total']; ?></th>
		<th><?php echo $view['text']['table-headings']['actions']; ?></th>
	</tr>
	</thead>
	<tbody>
<?php
	$totalPrice = 0;
	foreach ($view['trolley-data'] as $index => $item) {
		$totalPrice += $item->getQuantity() * $item->getUnitPrice();
		$inputId = sprintf('item-%d-quantity', $index);
?>
	<tr>
		<td><a href="<?php echo $item->getDetailsUrl(); ?>"><?php echo $item->getLabel(); ?></a></td>
		<td><?php echo implode('<br/>', array_map(function($attribute) { return $attribute['label']; }, $item->getAttributes())); ?></td>
		<td>$<?php echo number_format($item->getUnitPrice() / 100, 2); ?></td>
		<td>
			<form method="post" action="<?php echo $view['modify-item-url']; ?>" class="minimal">
				<nobr>
					<input type="hidden" name="form-url" value="<?php echo $view['form-url']; ?>" />
					<input type="hidden" name="index" value="<?php echo $index; ?>" />
					<label for="<?php echo $inputId; ?>" style="display:none;"></label>
					<input type="text" name="quantity" id="<?php echo $inputId; ?>" value="<?php echo number_format($item->getQuantity()); ?>" style="width:2em;" />
					<input type="submit" value="<?php echo $view['text']['quantity-button']; ?>" />
				</nobr>
			</form>
		</td>
		<td>$<?php echo number_format($item->getUnitPrice() * $item->getQuantity() / 100, 2); ?></td>
		<td>
			<form method="post" action="<?php echo $view['remove-item-url']; ?>" class="minimal">
				<input type="hidden" name="form-url" value="<?php echo $view['form-url']; ?>" />
				<input type="hidden" name="index" value="<?php echo $index; ?>" />
				<input type="submit" value="<?php echo $view['text']['remove-button']; ?>" />
			</form>
		</td>
	</tr>
<?php
	}
?>
	<tr>
		<td colspan="4"><?php echo $view['text']['table-total-labels']['subtotal']; ?></td>
		<td>$<?php echo number_format($totalPrice / 100, 2); ?></td>
		<td></td>
	</tr>
<?php
	foreach ($view['adjustments'] as $adjustment) {
?>
	<tr>
		<td colspan="4"><?php echo $adjustment['label']; ?></td>
		<td><?php echo $view['text']['unknown-value']; ?></td>
		<td></td>
	</tr>
<?php
	}
?>
	<tr>
		<td colspan="4"><?php echo $view['text']['table-total-labels']['total']; ?></td>
		<td><?php echo $view['text']['unknown-value']; ?></td>
		<td>
<?php
	echo \Sitegear\Util\TokenUtilities::replaceTokens(
		$view['text']['checkout-link'],
		array(
			'checkoutUrl' => $view['checkout-url']
		)
	);
?>
		</td>
	</tr>
	</tbody>
</table>
<?php
}
